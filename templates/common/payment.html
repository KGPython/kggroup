<div class="widget-box payment">
    <div class="widget-title"> <span class="icon"> <span class="glyphicon glyphicon-th"> </span></span>
        <h5>支付管理</h5>
        <span class="icon-add-btn">
            <input type="button" class="btn btn-success btn-xs pull-right" id="sumPayments" value="支付合计">
        </span>

    </div>
    <div class="widget-content nopadding">
        <table class="table table-striped table-hover table-form-my">
            <thead>
                <tr>
                    <th>选择</th>
                    <th>支付方式</th>
                    <th>支付额度</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody class="payList">
                <tr>
                    <td><input value="1" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="现金" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input value="2" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="代金卷" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input value="3" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="汇款" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input value="5" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="POS消费" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input value="4" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="赊销" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                {% comment %}<tr>
                    <td><input id="blankId" value="" type="checkbox"></td>
                    <td>
                        <select name="" id="blank" class="form-control">
                            <option value="">请选择银行打款方式</option>
                            <option value="3">汇款</option>
                            <option value="4">赊销</option>
                            <option value="5">POS消费</option>
                        </select>
                    </td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input id="" value="6" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="移动积分" disabled></td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>{% endcomment %}
                <tr>
                    <td><input id="parterId" value="" type="checkbox"></td>
                    <td>
                        <select name="" id="parter" class="form-control">
                            <option value="">请选择三方平台名称</option>
                            <option value="6">移动积分</option>
                            <option value="7">美团</option>
                            <option value="8">糯米</option>
                            <option value="10">慧购电子支付</option>
                            <option value="11">慧购店内支付</option>
                        </select>
                    </td>
                    <td><input type='text' class='form-control payVal'></td>
                    <td><input type='text' class='form-control'></td>
                </tr>
                <tr>
                    <td><input id="hjs" value="9" type="checkbox"></td>
                    <td><input type='text' class='form-control payName' value="黄金手" disabled></td>
                    <td>
                        <input type='text' class='form-control payVal' id="hjsVal" value="0" disabled>
                        <input type='hidden' id="hjsStr" value="">
                    </td>
                    <td><input type='text' class='form-control' id="remark-hjs" disabled></td>
                </tr>
            </tbody>
        </table>

        <div style="display: none; padding-right: 17px; background: rgba(0,0,0,0.5)" class="modal" id="hjsBox">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">
                           兑换码验证
                        </h4>
                    </div>
                    <div class="modal-body widget-content">
                        <table class="table table-striped table-form-my">
                            <thead>
                                <tr>
                                    <th>卡号</th><th>卡密</th><th>金额</th><th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" class='form-control changeCode'></td>
                                    <td><input type="text" class='form-control changeCode'></td>
                                    <td><input type="text" class='form-control hCost' disabled='disabled'></td>
                                    <td><button type="button" class="btn btn-danger btn-xs btn-del" onclick="delRow(this)">删除</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="close">关闭
                        </button>
                        <button type="button" class="btn btn-primary" id="submit">
                            提交更改
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
//计算混合支付的合计金额
$(document).on('click','.payment #sumPayments',function(){
    palyList = $('.payList').find('tr');
    var totalStr = '';
    var payTotal=0;
    var payIdList = [];
    for(var i=0;i<palyList.length;i++){
        var checkBox = $(palyList[i]).find('td').eq(0).find('input')[0];
        var flag = $(checkBox).is(':checked');
        var payName = '';
        var payVal= $(palyList[i]).find('td').eq(2).find('input').val();
        if(flag && payVal){
            var cardSaleTotalVal = parseFloat($(".Total #totalVal b").text());
            var payId =0;
            //获取支付ID
            if($(palyList[i]).find('td').eq(1).find('select')[0]){
                payId = $(palyList[i]).find('td').eq(1).find('select option:selected').val();
                payName = $(palyList[i]).find('td').eq(1).find('select option:selected').text();

            }else{
                payId = $(palyList[i]).find('td').eq(0).find('input[type=checkbox]').val();
                payName = $(palyList[i]).find('td').eq(1).find('input').val();
            }
            if(!payId){
                alert('请选择三方支付方式');
                break;
            }
            if(payId == '7' || payId == '8' || payId == '10' || payId == '11'  || payId == '12' || payId== '6'){
                if(payIdList.indexOf('1')>=0 || payIdList.indexOf('2')>=0 || payIdList.indexOf('3')>=0 || payIdList.indexOf('4')>=0 || payIdList.indexOf('5')>=0){
                    alert('混合支付存在异常，请核查');
                    $(palyList[i]).find('td').eq(2).find('input').val('');
                    break;
                }
            }
            payIdList.push(payId);
            if(payId == 5){//pos刷卡
                //规则1：门店DISC_LEVEL为1，则区分
                //规则2：订单超过最小返点金额+1000，则不区分；
                //规则3：订单金额在最小返点金额和最小返点金额+1000之间，则区分
                if(cardSaleTotalVal<(DISC_RATES[0].val_min+1000) && cardSaleTotalVal>=DISC_RATES[0].val_min && DISC_LEVEL=='1') {

                    var posVal = parseFloat($(palyList[i]).find('td').eq(2).find('input').val());
                    changeDiscValByPos(cardSaleTotalVal, posVal)
                }
            }
            else if(payId == 7 || payId == 8 || payId == 10){//美团、糯米、慧购
                changeDiscValByPayment(cardSaleTotalVal,0.02)
            }
            else if(payId == 11){//慧购
                    changeDiscValByPayment2(cardSaleTotalVal,0.02)
                }
            else if(payId== 6){//移动积分
                changeDiscValByPayment(cardSaleTotalVal,0.01)
            }
            else {
                setTotalBycardSaleTotalVal('',cardSaleTotalVal)
            }

            totalStr += payName +' : '+payVal+'元 ';
            remarks = $(palyList[i]).find('td').eq(3).find('input').val();
            if(remarks){
                totalStr += '(备注：'+remarks+'), ';
            }else{
                totalStr += ', ';
            }
            payTotal +=parseFloat(payVal);
        }

        $('.Total #payInfo span').html(totalStr);
        $('.Total #payTotal b').html(payTotal)
    }
});

</script>
<script>
//支付列表，三方平台切换
$(document).on('change','.payList #parter',function(){
    var val = $(this).val();
    var parentTr = $(this).parent().parent();
    $(parentTr).find('td').eq(0).find('input').val(val);
});
//支付方式--银行打款
/*var posVal = 0;
$(document).on('change','.payList #blank',function(){
    var val = $(this).val();
    var parentTr = $(this).parent().parent();
    $(parentTr).find('td').eq(0).find('input').val(val);
});*/

function changeDiscValByPayment(cardSaleTotalVal,discRate) {
     $('.Total-discInfo').hide();
    //设置折扣率
    $('.Total #discount input').val(discRate*100);
    //设置折扣金额
    var discountVal = (parseFloat(cardSaleTotalVal)*discRate);
    $('.Total #discountVal b').text(discountVal);
    //设置优惠补差
    $('.Total #totalYBalance b').text(0);
    //设置应付
    $('.Total #totalPaid b').text(cardSaleTotalVal);

    //设置优惠返现
    $('.discountTotal #Ycash').val(discountVal);

    $(".discBox").hide();
}

function changeDiscValByPayment2(cardSaleTotalVal,discRate) {
    $('.Total-discInfo').show();
    //计算折扣金额
    $('.Total #discount input').val(discRate*100);
    var discountVal = (parseFloat(cardSaleTotalVal)*discRate);
    $('.Total #discountVal b').text(discountVal);
    //优惠补差
    var discountCardTotalVal = parseFloat($(".discountTotal #totalVal b").text());
    discountPay  = discountCardTotalVal - discountVal;
    $('.Total #totalYBalance b').text(discountPay);
    //6、应付金额
    $('.Total #totalPaid b').text(cardSaleTotalVal+discountPay);
    //设置优惠返现
    $(".discBox").show();
    $(".discountTotal #Ycash").val(0)
}

/*
* 计算返点金额
* cardSaleTotalVal：cardSaleTotalVal：售卡总金额
* posVal：pos刷卡金额
* */
function changeDiscValByPos(cardSaleTotalVal,posVal) {
    if(cardSaleTotalVal-posVal>=DISC_RATES[0].val_min){
        setTotalBycardSaleTotalVal('',cardSaleTotalVal)
    }else{
        //4、优惠金额清零
        $('.Total #discountVal b').text(0);
        //5、优惠补差清零
        $('.Total #totalYBalance b').text(0);
        $('.Total #discount input').val(0);
        //6、设置订单应付金额 = 售卡列表合计金额 + 优惠补差
        $('.Total #totalPaid b').text(cardSaleTotalVal);
        $('.discBox').hide();
    }
}
</script>