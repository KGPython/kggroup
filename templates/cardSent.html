<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>领卡</title>
</head>
<body>
{% include 'common/head.html' %}
<!--containt-part-->
<div id="content">
    <div id="content-header">
        <div id="breadcrumb">
            <a data-original-title="Go to Home" href="#" title="" class="tip-bottom">
                <span class="glyphicon glyphicon-home" aria-hidden="true"> </span> 首页
            </a>
            <a href="#" class="current">领卡</a>
        </div>
    </div>
    <div class="widget-box">
        <div class="widget-title"> <span class="icon"> <span class="glyphicon glyphicon-th"> </span></span>
            <h5>领卡管理</h5>
        </div>
        <div class="widget-box">
            <table class="table table-striped table-hover table-form-my">
                <thead>
                    <tr>
                        <th>面值</th>
                        <th>起始卡号</th>
                        <th>结束卡号</th>
                        <th>小计</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody class="cardSent">
                    <tr>
                        <td>
                            <select name="" id="" class="form-control type">
                                {% for type in cardTypes %}
                                    <option value="{{ type.card_type_name }}">{{ type.card_type_name }}元</option>
                                {% endfor %}
                                <option value=""></option>
                            </select>
                        </td>
                        <td><input type='text' class='form-control start cardno'></td>
                        <td><input type='text' class='form-control end cardno'></td>
                        <td><input type='text' class='form-control subTotal'></td>
                        <td><button type="button" class="btn btn-danger btn-xs btn-del">删除</button></td>
                    </tr>
                </tbody>
            </table>
            <div class="row formline" style="margin-top: 15px;">
                    <label for="" class="col-xs-1 formline-label">领取门店：</label>
                    <div class="col-xs-4">
                        <select name="" id="shop" class="form-control" required="required">
                            {% for shop in shops %}
                                <option value="{{ shop.shop_code }}">{{ shop.shop_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <label for="" class="col-xs-1 formline-label">领取人：</label>
                    <div class="col-xs-4">
                        <input type="text" class="form-control" id="person" placeholder="" required="required">
                    </div>
                </div>
        </div>
        <div class="enter-box"><button class="btn btn-success pull-right btn-enter" type="button">提交订单</button></div>
    </div>
</div>
<!--end-containt-part-->

{% include "common/foot.html" %}
<script>
    function checkCross(obj){
        var key = parseInt($(obj).val());
        var trs = $(".cardSent").find('tr');
        var list =[];
        for(var j=0;j<trs.length;j++){
            var subNum = $(trs[j]).find('.subTotal').val();
            var start = $(trs[j]).find('.start').val();
            var end = $(trs[j]).find('.end').val();
            if(subNum && start && end){
                list.push({'start':parseInt(start),'end':parseInt(end)});
            }
        }
        for(var m=0;m<list.length;m++){
            var parentTr = $(obj).parent().parent();
            var start3 = parentTr.find('.start').val();
            var end3 = parentTr.find('.end').val();
            var start4 = list[m].start;
            var end4 = list[m].end;

            if(parseInt(start3)<parseInt(start4) && parseInt(end3)>parseInt(end4)){
                alert('卡断：'+start3+'-'+end3+',包含卡断：'+start4+'-'+end4+',请重新输入卡断');
                parentTr.find('.start').val('').focus();
                parentTr.find('.end').val('');
                return false;
            }
        }
        for(var i=0;i<list.length;i++){
            var start2 = list[i].start;
            var end2 = list[i].end;

            if((key>start2 && key<end2)){
                alert('卡号：'+key+',已经存在于卡段'+start2+'-'+end2+'中，请重新输入卡断');
                $(obj).val('').focus();
                return false;
            }
        }
    }
    function checkRepeat(obj){
        var key = $(obj).val();
        var cardInputs = $(".cardSent").find('.cardno');
        var list =[];
        for(var j=0;j<cardInputs.length;j++){
            var cardid = $(cardInputs[j]).val();
            if(cardid){
                list.push(cardid);
            }
        }
        list.remove(key);

        if(list.indexOf(key)>-1){
            alert('卡号：'+key+',已经存在于上面的卡段中，请检查');
            $(obj).val('').focus();
            return false;
        }
    }
</script>
<script>
    $(document).on('change','.cardSent .cardno',function(){

        //重复校验
        checkRepeat(this);
        //交叉校验
        checkCross(this);

        //计算小计
        var parentTr = $(this).parent().parent();
        var startStr = parentTr.find('.start').val();
        var start = startStr.split('=')[0];
        parentTr.find('.start').val(start);

        var endStr = parentTr.find('.end').val();
        var end = endStr.split('=')[0];
        parentTr.find('.end').val(end);
        if(parseInt(end)<parseInt(start)){
            alert('起始卡号不能大于截至卡号');
            return false;
        }
        if(parseInt(end)&&parseInt(start)){
            parentTr.find('.subTotal').val(parseInt(end)-parseInt(start)+1);
            //创建新的一行
            var tbody = $(".cardSent");
            var columsL = tbody.find('tr').eq(0).find('td').length;
            var row = $("<tr></tr>");
            for(var i=0;i<columsL;i++){
                var td = $("<td></td>");
                if(i==0){
                    var obj = $("<select type='text' class='form-control type'></select>");
                    var list={{ cardTypes | safe}};
                    for(var j=0;j<list.length;j++){
                        var option = $("<option></option>").val(list[j].card_type_name).text(list[j].card_type_name+'元');
                        $(obj).append(option)
                    }
                }else if(i==1){
                    var obj = $('<input type="text" class="form-control start cardno">');
                }else if(i==2){
                    var obj = $('<input type="text" class="form-control end cardno">');
                }else if(i==3){
                    var obj = $('<input type="text" class="form-control subTotal">');
                }else{
                    var obj = $('<button type="button" class="btn btn-danger btn-xs btn-del">删除</button>');
                }
                $(td).append(obj);
                $(row).append(td);
            }
            tbody.append(row)
        }

    });

    $('.btn-enter').click(function(){
        //卡列表
        var list=[];
        trs = $('.cardSent').find('tr');
        for(var i=0;i<trs.length;i++){
            var item ={};
            var cardType = $(trs[i]).find('td').eq(0).find('select').val();
            var start = $(trs[i]).find('td').eq(1).find('input').val();
            var end = $(trs[i]).find('td').eq(2).find('input').val();
            var subTotal = $(trs[i]).find('td').eq(3).find('input').val();
            if(subTotal){
                item['cardType'] = cardType;
                item['start'] = start;
                item['end'] = end;
                item['subTotal'] = subTotal;
                list.push(item);
            }
        }
        if(list.length<1){
            alert('请完善领卡列表后，再尝试提交');
            return false;
        }
        //领取人信息
        var shop = $('#shop').val();
        var person = $('#person').val();
        if(!shop || !person){
            alert('请完善领卡人员后，再尝试提交');
            return false;
        }
        $.ajax({
            url:'{% url 'sentOrderSave' %}',
            dataType:'json',
            method:'post',
            data:{
                'list':JSON.stringify(list),
                'shop':shop,
                'person':person
            },
            success:function(data){
                if(data.msg=='0'){
                    alert('数据提交成功');
                    $('input[type=text]').val('')
                }else if(data.msg=='1'){
                    alert('数据提交失败')
                }else if(data.msg=='2'){
                    var cardNo =data.cardId;
                    alert('卡号：'+cardNo+', 在数据库中已经存在，无法重复提交，请核查')
                }
            }
        })
    })
</script>
</body>
</html>
